@model IEnumerable<ISpanShop.MVC.Models.ViewModels.ProductReviewListVm>

@{
    ViewData["Title"] = "å•†å“å¯©æ ¸ä¸­å¿ƒ";
    var rejectedList = ViewBag.RejectedRecords as IEnumerable<ISpanShop.MVC.Models.ViewModels.ProductReviewListVm>;
}

<div class="container-fluid py-4 font-noto">

    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="fw-bold text-dark tracking-tight mb-1">å•†å“å¯©æ ¸ä¸­å¿ƒ</h2>
            <p class="text-muted mb-0 fs-7">
                å¾…å¯©æ ¸å•†å“å…± <span class="fw-bold text-warning" id="pendingCount">@(Model?.Count() ?? 0)</span> ç­†
            </p>
        </div>
        <a href="@Url.Action("Index")" class="btn btn-light rounded-pill px-4 border text-muted">
            <i class="bi bi-arrow-left me-1"></i> å›å•†å“ç¸½è¦½
        </a>
    </div>

    @* Bootstrap Nav Tabs *@
    <ul class="nav nav-tabs mb-0 border-0" id="reviewTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active px-4 py-2 fw-semibold" id="pending-tab"
                    data-bs-toggle="tab" data-bs-target="#pendingPanel"
                    type="button" role="tab">
                <i class="bi bi-hourglass-split me-1 text-warning"></i>
                å¾…å¯©æ ¸
                <span class="badge rounded-pill ms-1"
                      style="background:#fef3c7;color:#92400e;font-size:0.78rem;">@(Model?.Count() ?? 0)</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link px-4 py-2 fw-semibold" id="rejected-tab"
                    data-bs-toggle="tab" data-bs-target="#rejectedPanel"
                    type="button" role="tab">
                <i class="bi bi-x-circle me-1 text-danger"></i>
                è¿‘æœŸé€€å›ç´€éŒ„
                <span class="badge rounded-pill ms-1"
                      style="background:#fee2e2;color:#991b1b;font-size:0.78rem;">@(rejectedList?.Count() ?? 0)</span>
            </button>
        </li>
    </ul>

    <div class="tab-content" id="reviewTabsContent">

        <div class="tab-pane fade show active" id="pendingPanel" role="tabpanel">
            <div class="filter-card rounded-top-0" style="border-top-left-radius:0!important;border-top-right-radius:0!important;">
                @if (Model != null && Model.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-custom align-middle">
                            <thead>
                                <tr>
                                    <th>å•†å“åç¨±</th>
                                    <th>å•†åº—</th>
                                    <th>åˆ†é¡ / å“ç‰Œ</th>
                                    <th style="min-width:260px;">å•†å“æè¿°æ‘˜è¦</th>
                                    <th>å»ºæª”æ—¥æœŸ</th>
                                    <th class="text-end" style="min-width:200px;">å¯©æ ¸æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var product in Model)
                                {
                                    <tr data-id="@product.Id">
                                        <td>
                                            <div class="fw-bold text-dark">@product.Name</div>
                                        </td>
                                        <td class="text-muted fs-7">@(product.StoreName ?? $"Store #{product.StoreId}")</td>
                                        <td>
                                            <span class="badge-soft bg-primary-soft text-primary me-1">@product.CategoryName</span>
                                            <span class="badge-soft bg-info-soft text-info">@product.BrandName</span>
                                        </td>
                                        <td>
                                            <span class="text-muted fs-7">
                                                @if (!string.IsNullOrWhiteSpace(product.Description))
                                                {
                                                    @(product.Description.Length > 60
                                                        ? product.Description.Substring(0, 60) + "â€¦"
                                                        : product.Description)
                                                }
                                                else
                                                {
                                                    <span class="text-danger fw-bold">ï¼ˆç„¡æè¿°ï¼‰</span>
                                                }
                                            </span>
                                        </td>
                                        <td class="text-muted fs-7">@(product.CreatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-approve rounded-pill px-3 me-1"
                                                    data-id="@product.Id" data-name="@product.Name">
                                                <i class="bi bi-check-circle me-1"></i>æ ¸å‡†ä¸Šæ¶
                                            </button>
                                            <button class="btn btn-sm btn-reject rounded-pill px-3"
                                                    data-id="@product.Id" data-name="@product.Name">
                                                <i class="bi bi-x-circle me-1"></i>é€€å›
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <div class="text-success mb-3"><i class="bi bi-check-circle fs-1"></i></div>
                        <h5 class="fw-bold text-dark mb-1">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„å•†å“</h5>
                        <p class="text-muted fs-7 mb-0">æ‰€æœ‰å•†å“å‡å·²å®Œæˆå¯©æ ¸ï¼Œç¨å¾Œå†ä¾†æŸ¥çœ‹ã€‚</p>
                    </div>
                }
            </div>
        </div>

        <div class="tab-pane fade" id="rejectedPanel" role="tabpanel">
            <div class="filter-card rounded-top-0" style="border-top-left-radius:0!important;border-top-right-radius:0!important;">
                @if (rejectedList != null && rejectedList.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-custom align-middle">
                            <thead>
                                <tr>
                                    <th style="width:70px;">åœ–ç‰‡</th>
                                    <th>å•†å“åç¨±</th>
                                    <th>å•†å®¶</th>
                                    <th>é€€å›åŸå› </th>
                                    <th>é€€å›æ™‚é–“</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in rejectedList)
                                {
                                    <tr>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.MainImageUrl))
                                            {
                                                <img src="@item.MainImageUrl" alt="@item.Name"
                                                     style="width:54px;height:54px;object-fit:cover;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);" />
                                            }
                                            else
                                            {
                                                <div style="width:54px;height:54px;border-radius:10px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-size:1.3rem;">ğŸ–¼ï¸</div>
                                            }
                                        </td>
                                        <td class="fw-semibold text-dark">@item.Name</td>
                                        <td class="text-muted fs-7">@item.StoreName</td>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(item.RejectReason))
                                            {
                                                <span style="background:#fff0f0;color:#c53030;border-radius:6px;font-size:0.82rem;font-weight:500;padding:0.3em 0.7em;display:inline-block;">
                                                    @item.RejectReason
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted fs-7">ï¼ˆæœªå¡«å¯«ï¼‰</span>
                                            }
                                        </td>
                                        <td class="text-muted fs-7">@(item.UpdatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "â€”")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <div class="text-muted mb-2" style="font-size:2rem;">ğŸ“­</div>
                        <p class="text-muted mb-0">è¿‘æœŸç„¡é€€å›ç´€éŒ„</p>
                    </div>
                }
            </div>
        </div>

    </div>@* /tab-content *@

</div>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

    body { background-color: #f4f7f6; }
    .font-noto { font-family: 'Noto Sans TC', sans-serif; }
    .tracking-tight { letter-spacing: -0.5px; }
    .fs-7 { font-size: 0.9rem; }

    /* â”€â”€ Tabs æ¨£å¼ â”€â”€ */
    #reviewTabs .nav-link {
        color: #718096;
        border: 1px solid transparent;
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        background: rgba(255,255,255,0.5);
        transition: all 0.2s;
    }
    #reviewTabs .nav-link:hover { color: #2d3748; background: rgba(255,255,255,0.8); }
    #reviewTabs .nav-link.active {
        color: #2d3748;
        background: #fff;
        border-color: rgba(226,232,240,0.8);
        border-bottom-color: #fff;
    }

    /* â”€â”€ å¡ç‰‡ â”€â”€ */
    .filter-card {
        background: #ffffff;
        border-radius: 0 20px 20px 20px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.03);
        border: 1px solid rgba(226,232,240,0.8);
    }

    /* â”€â”€ æ‡¸æµ®å¡ç‰‡è¡¨æ ¼ â”€â”€ */
    .table-custom { border-collapse: separate; border-spacing: 0 10px; }
    .table-custom th { border: none; color: #718096; font-weight: 700; letter-spacing: 1px; font-size: 0.85rem; padding: 0.4rem 1.2rem; background: transparent; text-transform: uppercase; }
    .table-custom td { background: #fff; border: none; padding: 1rem 1.2rem; font-size: 0.95rem; }
    .table-custom td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
    .table-custom td:last-child  { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
    .table-custom tbody tr { box-shadow: 0 3px 12px rgba(0,0,0,0.03); transition: all 0.25s ease; }
    .table-custom tbody tr:hover { transform: translateY(-2px); box-shadow: 0 8px 22px rgba(0,0,0,0.07); }

    .badge-soft { padding: 0.35em 0.75em; border-radius: 6px; font-size: 0.8rem; font-weight: 600; }
    .bg-primary-soft { background-color: #ebf8ff; }
    .text-primary { color: #3182ce !important; }
    .bg-info-soft { background-color: #e6fffa; }
    .text-info { color: #319795 !important; }

    /* â”€â”€ å¯©æ ¸æŒ‰éˆ• â”€â”€ */
    .btn-approve { background-color: #c6f6d5; color: #276749; border: none; font-weight: 600; transition: all 0.2s; }
    .btn-approve:hover { background-color: #38a169; color: #fff; box-shadow: 0 4px 12px rgba(56,161,105,0.3); }
    .btn-reject  { background-color: #fed7d7; color: #9b2c2c; border: none; font-weight: 600; transition: all 0.2s; }
    .btn-reject:hover  { background-color: #e53e3e; color: #fff; box-shadow: 0 4px 12px rgba(229,62,62,0.3); }
</style>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
(function () {
    var urlApprove = '@Url.Action("ApproveProduct", "Products")';
    var urlReject  = '@Url.Action("RejectProduct",  "Products")';

    /* é é¢è¼‰å…¥æ™‚ï¼šè‹¥ hash == #rejectedTabï¼Œè‡ªå‹•åˆ‡æ›åˆ°é€€å›ç´€éŒ„é ç±¤ */
    document.addEventListener('DOMContentLoaded', function () {
        if (window.location.hash === '#rejectedTab') {
            var tabEl = document.querySelector('#rejected-tab');
            if (tabEl && typeof bootstrap !== 'undefined') {
                new bootstrap.Tab(tabEl).show();
            }
            history.replaceState(null, '', window.location.pathname + window.location.search);
        }
    });

    /** ç§»é™¤åˆ—ä¸¦æ›´æ–°è¨ˆæ•¸ï¼›è‹¥æ¸…ç©ºå‰‡é‡æ•´ */
    function removeRow(id) {
        var row = document.querySelector('tr[data-id="' + id + '"]');
        if (row) row.remove();
        var remaining = document.querySelectorAll('#pendingPanel tbody tr').length;
        var countEls  = document.querySelectorAll('#pendingCount, .text-warning.fw-bold');
        countEls.forEach(function (el) { el.textContent = remaining; });
        // åŒæ­¥æ›´æ–° tab badge
        var badge = document.querySelector('#pending-tab .badge');
        if (badge) badge.textContent = remaining;
        if (remaining === 0) location.reload();
    }

    /** â”€â”€ æ ¸å‡†ä¸Šæ¶ â”€â”€ */
    document.querySelectorAll('.btn-approve').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var id   = this.dataset.id;
            var name = this.dataset.name;

            Swal.fire({
                title: 'ç¢ºèªæ ¸å‡†ä¸Šæ¶',
                html:  'ç¢ºå®šè¦æ ¸å‡†å•†å“<br><strong>ã€Œ' + name + 'ã€</strong>ä¸Šæ¶å—ï¼Ÿ',
                icon:  'question',
                showCancelButton:   true,
                confirmButtonColor: '#38a169',
                cancelButtonColor:  '#a0aec0',
                confirmButtonText:  '<i class="bi bi-check-circle me-1"></i> ç¢ºèªæ ¸å‡†',
                cancelButtonText:   'å–æ¶ˆ'
            }).then(function (result) {
                if (!result.isConfirmed) return;

                fetch(urlApprove, {
                    method:  'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body:    'id=' + id
                })
                .then(function (r) { return r.json(); })
                .then(function (res) {
                    if (res.success) {
                        removeRow(id);
                        Swal.fire({
                            title: 'æ ¸å‡†æˆåŠŸï¼', text: res.message, icon: 'success',
                            confirmButtonColor: '#3182ce', timer: 2000, timerProgressBar: true
                        });
                    } else {
                        Swal.fire({ title: 'æ“ä½œå¤±æ•—', text: res.message, icon: 'error', confirmButtonColor: '#e53e3e' });
                    }
                })
                .catch(function () {
                    Swal.fire({ title: 'é€£ç·šéŒ¯èª¤', text: 'è«‹ç¨å¾Œå†è©¦ã€‚', icon: 'error', confirmButtonColor: '#e53e3e' });
                });
            });
        });
    });

    /** â”€â”€ é€€å›å¯©æ ¸ â”€â”€ */
    document.querySelectorAll('.btn-reject').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var id   = this.dataset.id;
            var name = this.dataset.name;

            Swal.fire({
                title:    'é€€å›å•†å“å¯©æ ¸',
                html:     'å•†å“ï¼š<strong>ã€Œ' + name + 'ã€</strong>',
                input:    'textarea',
                inputLabel:       'é€€å›åŸå› ï¼ˆå¿…å¡«ï¼‰',
                inputPlaceholder: 'è«‹å¡«å¯«é€€å›åŸå› ï¼Œæ­¤è¨Šæ¯å°‡è¨˜éŒ„æ–¼é€€å›ç´€éŒ„ä¸­...',
                inputAttributes:  { rows: 3 },
                icon:   'warning',
                showCancelButton:   true,
                confirmButtonColor: '#e53e3e',
                cancelButtonColor:  '#a0aec0',
                confirmButtonText:  '<i class="bi bi-x-circle me-1"></i> ç¢ºèªé€€å›',
                cancelButtonText:   'å–æ¶ˆ',
                inputValidator: function (value) {
                    if (!value || !value.trim()) return 'é€€å›åŸå› ç‚ºå¿…å¡«æ¬„ä½ï¼Œè«‹å¡«å¯«å¾Œå†é€å‡ºã€‚';
                }
            }).then(function (result) {
                if (!result.isConfirmed) return;

                var reason = result.value.trim();

                fetch(urlReject + '?id=' + id + '&reason=' + encodeURIComponent(reason), {
                    method: 'POST'
                })
                .then(function (r) { return r.json(); })
                .then(function (res) {
                    if (res.success) {
                        removeRow(id);
                        Swal.fire({
                            title: 'å·²é€€å›ï¼', text: res.message, icon: 'success',
                            confirmButtonColor: '#3182ce', timer: 2000, timerProgressBar: true
                        }).then(function () {
                            /* é€€å›å¾Œè·³è½‰åˆ°é€€å›ç´€éŒ„é ç±¤ */
                            window.location.hash = '#rejectedTab';
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({ title: 'æ“ä½œå¤±æ•—', text: res.message, icon: 'error', confirmButtonColor: '#e53e3e' });
                    }
                })
                .catch(function () {
                    Swal.fire({ title: 'é€£ç·šéŒ¯èª¤', text: 'è«‹ç¨å¾Œå†è©¦ã€‚', icon: 'error', confirmButtonColor: '#e53e3e' });
                });
            });
        });
    });
})();
</script>
}
